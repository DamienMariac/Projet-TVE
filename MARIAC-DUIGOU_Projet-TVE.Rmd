---
title: "MARIAC-DUIGOU_PROJT-TVE"
output: html_document
date: "2026-02-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
load("donneesStations.RData")
load("donneesVagues.RData")
```

```{r}
library(dplyr)
library(lubridate)

Sa=data.frame("date"=donneesVague$date,"station6"=donneesVague$station6)
Sb=data.frame("date"=donneesVague$date,"station14"=donneesVague$station14)

Sa$date=as.POSIXct(Sa$date)
Sb$date=as.POSIXct(Sb$date)
Sa = Sa %>%
  mutate(year = year(date)) %>%
  group_by(year) %>%
  summarise(waves_length = max(station6, na.rm = TRUE))
Sb = Sb %>%
  mutate(year = year(date)) %>%
  group_by(year) %>%
  summarise(waves_length = max(station14, na.rm = TRUE))
```

# PARTIE 1

```{r}
plot(Sa$year,Sa$waves_length)
```

## Méthode gev

### Avec gev.fit

Estimer les paramètres de la gev avec gev.fit
```{r}
library(ismev)

GEVa=gev.fit(Sa$waves_length)

# Intervalles de confiance à 95%
IC=list()
for (i in 1:3){
  IC[[i]]=c(GEVa$mle[i]-1.96*GEVa$se[i],GEVa$mle[i]+1.96*GEVa$se[i])
}
IC
```

L'intervalle de confiance de gamma est très large...On peut pas savoir dans quel domaine d'attraction nous sommes.

Avec vraissemblance profilé 
```{r}
profiled_llh=gev.profxi(GEVa,xlow=-1,xup=1,conf=0.95,nint=100)
profiled_llh$conf
```
IC trop difficile à estimer via vraissemblance profilée donc renvoie NULL.

Le mle donne un gamma négatif et la borne sup de l'IC environ égale à 0 donc peut être domaine d'attraction de Weibull.

Estimation de la value at risk pour les période 100,500,1000 ans 
```{r}
q1=1/100
q2=1/500
q3=1/1000
n=dim(donneesVague)[1]/dim(Sa)[1]
yq1=-log(1-q1)
yq2=-log(1-q2)
yq3=-log(1-q3)

xq1=GEVa$mle[1]-(GEVa$mle[2]/GEVa$mle[3])*(1-(yq1)^(-GEVa$mle[3]))
xq2=GEVa$mle[1]-(GEVa$mle[2]/GEVa$mle[3])*(1-(yq2)^(-GEVa$mle[3]))
xq3=GEVa$mle[1]-(GEVa$mle[2]/GEVa$mle[3])*(1-(yq3)^(-GEVa$mle[3]))

xq1
xq2
xq3
```
####TODO#### Intervalles de confiance à faire 

```{r}
gev.diag(GEVa)
```

### Avec fgev

```{r}
library(evd)

fgev(Sa$waves_length,prob=q1)
fgev(Sa$waves_length,prob=q2)
fgev(Sa$waves_length,prob=q3)
```

Résultats proches de gev.fit

####TODO#### Intervalles de confiance

### Fitter directement une gumbell

On a vu que 0 appartient à l'IC de gamma donc on poourrait fitter un modèle de Gumbell puis faire un test statistique pour valider ou non un tel modèle.

```{r}
GUMa=gum.fit(Sa$waves_length)
gum.diag(GUMa)
```
Quantile plot très bof pour les fortes valeurs. Mais pour le modèle gev.fit il n'allait pas au-delà de 8.5. Pour les valeurs en dessous de 8.5 les deux graph sont raisonnablement les mêmes. Le return level plot semble dépasser les IC du graph pour des value at risk proches de 100. Cependant l'histogramme de fréquence semble plus en adéquation avec le modèle que pour la gev.


On peut redonner les Value at risk avec ce nouvel ajustement 
```{r}
xqg1=GUMa$mle[1]-GUMa$mle[2]*log(yq1)
xqg2=GUMa$mle[1]-GUMa$mle[2]*log(yq2)
xqg3=GUMa$mle[1]-GUMa$mle[2]*log(yq3)

xqg1
xqg2
xqg3
```
bien plus élevés que pour le précédent modèle. Normal car pour un gamma négatif, nous sommes dans le domaine d'attraction de Weibull qui suggère qu'on ne dépassera pas une certaine limite (visiblement dépassée lorsqu'on fit une Gumbell)

### Comparaison de modèle

Nous avons un modèle produit par gev.fit et un modèle de Gumbell produit par gum.fit. 
La comparaison entre ces modèles consiste alors en la confrontation des hypothèses suivantes :
H0:gamma=0 vs H1:gamma!=0

```{r}
l1=-GEVa$nllh
l2=-GUMa$nllh
D=2*(l1-l2)
D
```
On remarque que D<3.84 (quantile d'ordre 0.95 d'une khi2(1)) (valeurs proches)
Donc avec un risque de 5% on garde l'hypothèse gamma=0. a discuter...

"Meilleur" modèle : GUMa qui donne les value at risk  :
```{r}
xqg1
xqg2
xqg3
```

# Méthode GPD(POT)

```{r}
mrlplot(Sa$waves_length)
```
à peu près linéraire (décroissant) à partir du seuil 7.5 (environ) qu'on choisit de retenir comme seuil partir duquel on considère que les dépassments suivent une gpd.
Décroissance indique gamma<0 domaine d'attraction de Weibull (cohérent) 
Choix du précédent seuil : 7 mais 40% de dépassement ce qui est élevé.

value at risk pour 100,500,1000 ans 
```{r}
GPDa100=fpot(Sa$waves_length,7.5,npp=1,mper=100,std.err = FALSE)
xpot1=GPDa100$estimate[1]
par(mfrow=c(2,2))
plot(GPDa100)
GPDa500=fpot(Sa$waves_length,7.5,npp=1,mper=500)
xpot2=GPDa500$estimate[1]
par(mfrow=c(2,2))
plot(GPDa500)
GPDa1000=fpot(Sa$waves_length,7.5,npp=1,mper=1000,std.err = FALSE)
xpot3=GPDa1000$estimate[1]
par(mfrow=c(2,2))
plot(GPDa1000)
xpot1
xpot2
xpot3

GPDa100
```

Estimations inférieures aux estimations par gumbell (modèle retenu pour la méthode gev). 
seuil à revoir car environ 23% de dépassement
Les graph sont vraiment pas top...

Choix de maximum en prenant les max par années, ce qui représente peu de données (52 observations) Ce choix facilitait les calculs des value at risk car les période était en années. 

Reprendre l'étude avec des maximas par jour/mois (attention à la dépendance dûe à la saisonnalité) pour avoir plus d'observations ?

# Bivariée 

```{r}
plot(Sa$waves_length,Sb$waves_length)
```

Estimation des modèles gev des deux stations
```{r}
fa=gum.fit(Sa$waves_length)
fb=gev.fit(Sb$waves_length)
```
Pour la station 14, l'estimation de gamma est positive ce qui traduit un domaine d'attraction de Frêchet (queue lourde (plus que pour une gumbell) proportionnelle à une puissance négative). Son intervalle de confiance oscille entre négatif et positif donc faire comparaison de modèle avec une Gumbel :
```{r}
fbg=gum.fit(Sb$waves_length)

l1=-fb$nllh
l2=-fbg$nllh
D=2*(l1-l2)
D
```
D<<3.84 donc Gumbell "meileur" modèle.
```{r}
fb=fbg
```

Mise sous même échelle : transformation en Frêchet(1) et comparaison par plot 
```{r}
fsa=qgev(pgev(Sa$waves_length, loc=fa$mle[1], scale=fa$mle[2],shape=0),loc=1,shape=1,scale=1)
fsb=qgev(pgev(Sb$waves_length, loc=fb$mle[1], scale=fb$mle[2],shape=0),loc=1,shape=1,scale=1)

plot(fsa,fsb,xlim=c(0,max(max(fsa),max(fsb))),ylim=c(0,max(max(fsa),max(fsb))))
```

Les points semblent proches des axes mais en restent éloignés pour des fortes valeurs, sans pour autant se rapprocher de la première bisectrice. Cela donne une première intuition qu'il existe une dépendance entre les deux stations mais faible. A vérifier avec l'estimation de la fonction de Pickands qui donne une information visuelle de la dépendance et permet d'estimer theta qui donne une valeur quantifiable de la dépendance. On pourra également observer les limites des fonction khi(u) et khi_bar(u) pour u tend vers 1. Le model fitté de la MGEV en donne également une estimation (un plot de ce modèle donne la visualisation de la fonction de Pickands)

Modèle MGEV
```{r}
mod_log=fbvevd(cbind(Sa$waves_length,Sb$waves_length),model='log')
mod_alog=fbvevd(cbind(Sa$waves_length,Sb$waves_length),model='alog')
mod_nlog=fbvevd(cbind(Sa$waves_length,Sb$waves_length),model='neglog')

# Choix de modèle 
AIC(mod_log,mod_alog,mod_nlog)
```

Plus petit AIC : le modèle logistique négatif donc garder ce modèle (mod_nlog)

Résultats et graphs :
```{r}
mod_nlog
plot(mod_nlog)
theta=abvnonpar(data=cbind(Sa$waves_length,Sb$waves_length))*2
theta
```

La fonction de dépendance donne l'intuition qu'il y a une dépendance mais pas excessive. La valeur de alpha est d'environ 0.54 et de theta environ 1.53. Donc il y a dépendance et la "force" de la dépendance est moyenne. La densité spectral montre que la densité s'affaiblit fortement lorsqu'on approche 0 et 1 indiquant que nous ne sommes pas dans un cas d'indépendance.

Graphes de khi et khi_bar 
```{r}
Sa=data.frame("date"=donneesVague$date,"station6"=donneesVague$station6)
Sb=data.frame("date"=donneesVague$date,"station14"=donneesVague$station14)

Sa$date=as.POSIXct(Sa$date)
Sb$date=as.POSIXct(Sb$date)

chiplot(cbind(Sa$station6,Sb$station14))
```

En limite, le khi est éloigné de 0 en 0.5 (traduit une dépendance asymptotique de force d'environ 0.5). Le khi_bar est peu éloigné de 1 entre 0.7 et 0.8 (traduit une indépendance asymptotique de force d'environ 0.7 ou 0.8).

On s'attendait à une plus forte dépendance étant donné la proximité des stations. 




# Partie bivariée avec la station la plus proche de la staion 6 

```{r}
Sa=data.frame("date"=donneesVague$date,"station6"=donneesVague$station6)
Sa$date=as.POSIXct(Sa$date)

Sp=data.frame("date"=donneesVague$date,"station4"=donneesVague$station4)
Sp$date=as.POSIXct(Sp$date)
```

```{r}
plot(Sa$station6,Sp$station4,main="Hauteur des vagues des deux stations",xlab="Hauteur des vagues de la station 6",ylab="Hauteur des vagues de la station 4",col="red")
```

```{r}
fa=fgev(Sa$station6)
fp=fgev(Sp$station4)
```

```{r}
fsa=qgev(pgev(Sa$station6, loc=fa$estimate[1], scale=fa$estimate[2],shape=fa$estimate[3]),loc=1,shape=1,scale=1)
fsp=qgev(pgev(Sp$station4, loc=fp$estimate[1], scale=fp$estimate[2],shape=fp$estimate[3]),loc=1,shape=1,scale=1)

plot(fsa,fsp,xlim=c(0,max(max(fsa),max(fsp))),ylim=c(0,max(max(fsa),max(fsp))),main="Hauteur des vagues des deux stations",xlab="Hauteur des vagues de la station 6",ylab="Hauteur des vagues de la station 4",col="red")
```
Modèle MGEV
```{r}
mod_log=fbvevd(cbind(Sa$station6,Sp$station4),model='log')
mod_alog=fbvevd(cbind(Sa$station6,Sp$station4),model='alog')
mod_hr=fbvevd(cbind(Sa$station6,Sp$station4),model='hr')

# Choix de modèle 
AIC(mod_log,mod_alog,mod_hr)
```

```{r}
mod_alog
```

```{r}
chiplot(cbind(Sa$station6,Sp$station4))
```



## En prenant les maximas par année
```{r}
Sa = Sa %>%
  mutate(year = year(date)) %>%
  group_by(year) %>%
  summarise(waves_length = max(station6, na.rm = TRUE))

Sp = Sp %>%
  mutate(year = year(date)) %>%
  group_by(year) %>%
  summarise(waves_length = max(station4, na.rm = TRUE))
```


domaine d'attraction de Gumbell ou non ? 
```{r}
fp=gev.fit(Sp$waves_length)
fpg=gum.fit(Sp$waves_length)

l1=-fp$nllh
l2=-fpg$nllh
D=2*(l1-l2)
D
```
D<3.84 donc modèle de gumbell préférable. 
```{r}
fp=fpg
```

Mise sous une même échelle :
```{r}
fsa=qgev(pgev(Sa$waves_length, loc=fa$mle[1], scale=fa$mle[2],shape=0),loc=1,shape=1,scale=1)
fsp=qgev(pgev(Sp$waves_length, loc=fp$mle[1], scale=fp$mle[2],shape=0),loc=1,shape=1,scale=1)

plot(fsa,fsp,xlim=c(0,max(max(fsa),max(fsp))),ylim=c(0,max(max(fsa),max(fsp))))
```
Aux extrêmes, les points sont éloignés de la première bisectrice mais ne semblent pas tendre vers les axes non plus. Cela caracyérise l'existence d'une dépendance entre les deux stations mais qui semble être faible. 



Modèle MGEV
```{r}
mod_log=fbvevd(cbind(Sa$waves_length,Sp$waves_length),model='log')
mod_alog=fbvevd(cbind(Sa$waves_length,Sp$waves_length),model='alog',std.err=FALSE)
mod_nlog=fbvevd(cbind(Sa$waves_length,Sp$waves_length),model='neglog')

# Choix de modèle 
AIC(mod_log,mod_alog,mod_nlog)
```
Le plus petit AIC est pour le modèle negative logistique donc on garde mod_nlog

Résultats et graphs :
```{r}
mod_nlog
plot(mod_nlog, which=c(1,2,3,4,5))
theta=abvnonpar(data=cbind(Sa$waves_length,Sp$waves_length))*2
theta
```
alpha environ égal à 0.42. L'estimateur de la fonction de dépendance semble indiquer que les deux station ne sont pas trop dépendantes (moins que pour les stations 6 et 14 en tout cas)
theta environ egal à 1.85 ce qui est assez proche de 2 donc dépendance plutôt faible. On s'attendait au contraire car les deux stations sont très proches.

Graphes de khi et khi_bar 
```{r}
Sa=data.frame("date"=donneesVague$date,"station6"=donneesVague$station6)
Sp=data.frame("date"=donneesVague$date,"station4"=donneesVague$station4)

Sa$date=as.POSIXct(Sa$date)
Sp$date=as.POSIXct(Sp$date)

chiplot(cbind(Sa$station6,Sp$station4))
```
La valeur de khi est très proche de 0 indiquant une faible dépendance asymptotique entre les deux stations. Le khi_bar est entre 0.25 et 0.75. Ce qui signifie qu'on est dans un cas d'indépendance asymptotique et que les valeurs de khi_bar donnent la force de dépendance au seuil u. 


# Partie bivariée avec la station la plus éloignée de la staion 6 
```{r}
Se=data.frame("date"=donneesVague$date,"station19"=donneesVague$station19)
Sa=data.frame("date"=donneesVague$date,"station6"=donneesVague$station6)
Sa$date=as.POSIXct(Sa$date)
Sa = Sa %>%
  mutate(year = year(date)) %>%
  group_by(year) %>%
  summarise(waves_length = max(station6, na.rm = TRUE))

Se=data.frame("date"=donneesVague$date,"station19"=donneesVague$station19)
Se$date=as.POSIXct(Se$date)
Se = Se %>%
  mutate(year = year(date)) %>%
  group_by(year) %>%
  summarise(waves_length = max(station19, na.rm = TRUE))
```

domaine d'attraction de Gumbell ou non ? 
```{r}
fe=gev.fit(Se$waves_length)
feg=gum.fit(Se$waves_length)

l1=-fe$nllh
l2=-feg$nllh
D=2*(l1-l2)
D
```
D<3.84 donc on accepte l'hypothèse que la station 19 est dans le domaine d'attraction de Gumbell

```{r}
fe=feg
```

Mise sous même échelle : transformation en Frêchet(1) et comparaison par plot 
```{r}
fsa=qgev(pgev(Sa$waves_length, loc=fa$mle[1], scale=fa$mle[2],shape=0),loc=1,shape=1,scale=1)
fse=qgev(pgev(Se$waves_length, loc=fe$mle[1], scale=fe$mle[2],shape=0),loc=1,shape=1,scale=1)

plot(fsa,fse,xlim=c(0,max(max(fsa),max(fse))),ylim=c(0,max(max(fsa),max(fse))))
```

Même constat que pour l'étude précédente

Modèle MGEV
```{r}
mod_log=fbvevd(cbind(Sa$waves_length,Se$waves_length),model='log')
mod_alog=fbvevd(cbind(Sa$waves_length,Se$waves_length),model='alog')
mod_nlog=fbvevd(cbind(Sa$waves_length,Se$waves_length),model='neglog')
mod_hr=fbvevd(cbind(Sa$waves_length,Se$waves_length),model='hr')

# Choix de modèle 
AIC(mod_log,mod_alog,mod_nlog,mod_hr)
```
Le plus faible AIC est pour le modèle asymétrique logistique que l'on gardera 

Résultats et graphs :
```{r}
mod_alog
plot(mod_alog)
theta=abvnonpar(data=cbind(Sa$waves_length,Se$waves_length))*2
theta
```

alpha environ égal à 0.31 ce qui est faible. On peut penser que les deux stations sont faiblement dépendante. Cependant la valeur de théta qui est d'environ 1.92 qui est très proche de 2, caractérisant une très faible dépendance entre les deux. Ces remarques se valident par l'estimateur de la fonction de dépendance qui est assez proche de la droite x=1 (On rappelle qu'une indépendance totale donne theoriquement une fonction de dépendance constante égale à 1). En t=1/2, elle atteint même 0.96 environ (théta/2). Lorsqu'on est en situation d'indépendance, elle vaut 1. La densité spectral a une masse très forte en 0.18 environ.

Graphes de khi et khi_bar 
```{r}
Sa=data.frame("date"=donneesVague$date,"station6"=donneesVague$station6)
Se=data.frame("date"=donneesVague$date,"station19"=donneesVague$station19)

Sa$date=as.POSIXct(Sa$date)
Se$date=as.POSIXct(Se$date)

chiplot(cbind(Sa$station6,Se$station19))
```

khi=0 et on a khi_bar environ égal à 0.2<1 Cela signifie qu'on est dans un cas d'indépendance asymptotique et que les valeurs de khi_bar en u donnent la force de la dépendance au seuil u.




